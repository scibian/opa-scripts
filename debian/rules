#!/usr/bin/make -f
#
# Copyright (c)2016 System Fabric Works, Inc. All Rights Reserved,
#

VERSION := $(shell cat version_delta)
INSTFILES := $(shell find debian/opa-scripts -type f)

%:
	dh $@ --with=systemd

override_dh_auto_clean:
	rm -f opa-init-kernel opa-arptbl-tuneup

override_dh_auto_install:
	dh_auto_install $@

	cp opa.service debian/opa-scripts.opa.service
	install -d -m 0755 debian/opa-scripts/usr/sbin
	install -m 0755 opad.sbin debian/opa-scripts/usr/sbin/opa-init-kernel
	install -m 0755 arptbl_tuneup debian/opa-scripts/usr/sbin/opa-arptbl-tuneup

	install -d -m 0755 debian/opa-scripts/etc/opa
	install -m 0644 limits.conf debian/opa-scripts/etc/opa
	install -m 0644 udev.permissions debian/opa-scripts/etc/opa
	install -m 0644 udev.rules debian/opa-scripts/etc/opa

	install -d -m 0755 debian/opa-scripts/etc/rdma
	install -m 0644 debian/etc-rdma-rdma.conf debian/opa-scripts/etc/rdma/rdma.conf
	install -d -m 0755 debian/opa-scripts/etc/modules-load.d
	install -m 0644 debian/etc-modules-load-rdma.conf debian/opa-scripts/etc/modules-load.d/rdma.conf

	install -d -m 0755 debian/opa-scripts/sbin
	install -m 0755 opaautostartconfig debian/opa-scripts/sbin/opaautostartconfig
	install -m 0755 opasystemconfig debian/opa-scripts/sbin/opasystemconfig

	install -d -m 0755 debian/opa-scripts/usr/share/man/man1
	install -m 0644 opa-arptbl-tuneup.1 debian/opa-scripts/usr/share/man/man1
	install -m 0644 opa-init-kernel.1 debian/opa-scripts/usr/share/man/man1
	install -m 0644 opaautostartconfig.1 debian/opa-scripts/usr/share/man/man1

	install -d -m 0755 debian/opa-scripts/usr/lib/opa
	install -m 0755 .comp_ofed_delta.pl debian/opa-scripts/usr/lib/opa

	install -m 0644 version_delta debian/opa-scripts/etc/opa/version_delta

	echo `find debian/opa-scripts -type f -exec sed "s/\(ICS VERSION STRING:\s*\)unknown/\1$(VERSION)/" -i {} \; `

override_dh_systemd_enable:
	dh_systemd_enable -popa-scripts --name opa opa.service
